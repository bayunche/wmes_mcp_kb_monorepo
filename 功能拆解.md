# MCP 知识库功能拆解

> 本文梳理仓库的核心能力，映射到对应 TypeScript 文件，并以文字描述端到端数据流。用于研发/运维快速定位职责。

## 1. 模块总览

| 模块 | 主要职责 | 关键 TS 文件 |
| --- | --- | --- |
| API 网关 | Bun REST 服务，负责鉴权、上传、文档治理、检索、MCP 代理、Prometheus metrics | `apps/api/src/main.ts`, `apps/api/src/server.ts`, `apps/api/src/routes.ts`, `apps/api/src/auth.ts`, `apps/api/src/modelCatalog.ts` |
| Ingestion Worker | 消费 RabbitMQ，执行 fetch → parse → chunk → metadata → embed → persist | `apps/worker/src/main.ts`, `apps/worker/src/worker.ts`, `apps/worker/src/pipeline.ts`, `apps/worker/src/types.ts` |
| 混合检索与共享依赖 | HybridRetriever、VectorClient、parser/OCR/semantic 模块与数据层 | `packages/core/src/{config,retrieval,vector,parsing,ocr,semantic-metadata,semantic-structure,preprocess}.ts`, `packages/data/src/index.ts` 及其 queue/storage/repository 实现 |
| MCP Server | 以 MCP 工具暴露检索、相关内容、预览能力，可直接供 Agent 或由 API 代理；`preview` 返回 chunk 正文+元数据+附件 | `apps/mcp/src/main.ts`, `apps/mcp/src/index.ts`, `apps/mcp/src/server.ts`, `apps/mcp/src/tools/{search,related,preview}.ts`, `apps/mcp/src/repository/db.ts` |
| Web 控制台 | React 前端，企业级玻璃态界面，覆盖上传、队列、搜索、元数据治理、MCP 预览 | `apps/web/src/main.tsx`, `apps/web/src/App.tsx`, `apps/web/src/pages/*.ts` |
| 脚本与运维 | 自动化部署/验证/模型同步等辅助脚本 | `scripts/*.ts`（例如 `scripts/api-smoke.ts`, `scripts/run-migrations.ts`, `scripts/test-matrix.ts`）|

## 2. 功能点明细

### 2.1 API 网关（`apps/api`）

| 功能点 | 描述 | TS 文件 |
| --- | --- | --- |
| 启动与依赖装配 | `bootstrap()` 加载配置 → `createDataLayer()` → `VectorClient` → `HybridRetriever` → `startApiServer()`，同时启动 Prometheus metrics | `apps/api/src/main.ts` |
| HTTP 服务、鉴权与 CORS | `startApiServer()` 包装 Bun `serve()`，实现自定义 CORS、OPTIONS 预检、`/metrics` 暴露，并依赖 `requireAuth()` 强制 Bearer Token | `apps/api/src/server.ts`, `apps/api/src/auth.ts` |
| 文档读取与治理 | 多个 `/documents` 路由：列表、创建（同时入队）、标签更新、删除、重索引；`/documents/:id/chunks`、`/documents/:id/structure` 提供块和结构树浏览 | `apps/api/src/routes.ts` |
| 文件上传与入栈 | `/upload` 解析 multipart，写入对象存储 `ObjectStorage.persistUploadedFile`，使用 `DocumentSchema` 校验，并调用 `queue.enqueue` 触发 Worker | `apps/api/src/routes.ts` 中的 `handleUpload()` |
| 模型配置治理 | `/model-settings` + `/model-settings/catalog` 暴露模型列表、读写 ModelSetting，复用 `apps/api/src/modelCatalog.ts`，错误提示中文化 | `apps/api/src/routes.ts`, `apps/api/src/modelCatalog.ts` |
| 库/块/附件检索 | `/libraries/:id/chunks` 按库列出 chunk+附件，支持 tenant/doc 过滤；`/vector-logs` 查询 Worker 写入日志 | `apps/api/src/routes.ts` |
| 混合检索与过滤 | `/search` 调用 `HybridRetriever.search()`（向量 + BM25 融合，rerank 可选），支持 metadata/semanticTags/envLabels/hasAttachments 过滤 | `apps/api/src/routes.ts` |
| MCP HTTP 代理 | `/mcp/search|related|preview` 复用 `apps/mcp` 工具，实现 REST-to-MCP 桥接 | `apps/api/src/routes.ts`, `apps/mcp/src/tools/*.ts` |
| 入库队列可视化 | `/ingestion/queue` 返回最近文档的 status_meta 进度与阶段时间线，供前端队列页面使用 | `apps/api/src/routes.ts` |
| Chunk 元数据更新 | `/chunks` PATCH 支持 semanticTags/topics/keywords/contextSummary/semanticTitle/parentSectionPath/bizEntities/envLabels/entities 更新 | `apps/api/src/routes.ts` |
| 可观测性 | `/health` 轻量健康检查，`/metrics` 暴露 Prometheus 指标，MetricsRegistry 记录请求/错误/延迟 | `apps/api/src/server.ts` |

### 2.2 Ingestion Worker（`apps/worker`）

| 功能点 | 描述 | TS 文件 |
| --- | --- | --- |
| Worker 启动 | `startWorker()`/`bootstrap()` 加载 config，创建 data layer，检验本地向量模型，构建 parser、OCR、VectorClient、Metrics，并订阅队列 | `apps/worker/src/main.ts`, `apps/worker/src/worker.ts` |
| 队列适配 | 默认使用 `RabbitQueueAdapter`（`packages/data/src/queue/rabbitmq.ts`）消费 `kb.ingestion` 队列，并在失败时更新文档状态 | `apps/worker/src/worker.ts`, `apps/worker/src/pipeline.ts`（`handleQueueMessage`） |
| 原文获取 | `fetchSource()` 根据 document/sourceUri 或上传文件定位 MinIO raw object，必要时落盘临时文件 | `apps/worker/src/pipeline.ts` + `packages/data/src/storage/minio.ts` |
| 解析与 OCR | `parseDocument()` 组合同步/异步 parser，必要时触发 `HttpOcrAdapter`/`LocalOcrAdapter`；Parser 定义在 `packages/core/src/parsing.ts`，OCR 适配在 `packages/core/src/ocr.ts` | `apps/worker/src/pipeline.ts`, `packages/core/src/parsing.ts`, `packages/core/src/ocr.ts` |
| 预处理与语义切分 | 标准化文本 → 按章/节/标题/空行/短行预分段（含英文连字符处理）生成 coarse segments → 对每段调用 `semanticSegmenter`（LLM）生成 section blueprint | `apps/worker/src/pipeline.ts`, `packages/core/src/preprocess.ts`, `packages/core/src/semantic-structure.ts` |
| Chunk 切分与元数据抽取 | `materializeChunksFromBlueprints()` 依据段落与 token 上限生成小 chunk，保留 `hierPath`/`parentSectionPath`；`extractMetadata()` 调用 LLM 生成标题/摘要/标签/关键词/NER/父路径 | `apps/worker/src/pipeline.ts`, `packages/core/src/semantic-metadata.ts` |
| 标签与向量日志 | `generateRemoteTags()` 并发 3 路、3 次重试/退避；失败会抛错；`vectorLogs.append()` 记录 embed 成功/失败 | `apps/worker/src/pipeline.ts`, `packages/data/src/repositories/vectorLogs.ts` |
| 向量化 | `embedChunks()` 通过 `VectorClient` 生成文本/图像向量，并附加 provider 元数据 | `apps/worker/src/pipeline.ts`, `packages/core/src/vector.ts` |
| 入库 | `knowledgeWriter.persistBundle()` 一次性写入 documents/chunks/embeddings/attachments/sections，并同步 Qdrant/pgvector | `packages/data/src/repositories/knowledge.ts` |

### 2.3 混合检索与共享依赖

| 功能点 | 描述 | TS 文件 |
| --- | --- | --- |
| 配置加载 | `.env` → `loadConfig()` 将运行所需端口、向量模型、OCR、存储端点注入 | `packages/core/src/config.ts` |
| 混合检索 | `HybridRetriever.search()` 向量相似度 + BM25 分数融合，保留可选 rerank；支持邻居扩展 | `packages/core/src/retrieval.ts` |
| VectorClient | 统一封装本地 @xenova/transformers 与远程 API，支持文本/图像/rerank | `packages/core/src/vector.ts` |
| Parser/OCR/预处理 | 可扩展 parser pipeline、OCR 适配器与文本预处理 | `packages/core/src/parsing.ts`, `packages/core/src/ocr.ts`, `packages/core/src/preprocess.ts` |
| 数据层 | `createDataLayer()` 拼装 Kysely repos、MinIO、RabbitMQ、Qdrant；`Pg*Repository` 提供 documents/chunks/attachments/modelSettings/vectorLogs 操作 | `packages/data/src/index.ts`, `packages/data/src/repositories/*.ts`, `packages/data/src/storage/minio.ts`, `packages/data/src/queue/rabbitmq.ts` |

### 2.4 MCP Server（`apps/mcp`）

| 功能点 | 描述 | TS 文件 |
| --- | --- | --- |
| HTTP 入口 | `bootstrap()` 启动 Bun 服务器监听 `/mcp/*`，根据路径和 body 调用 `handleMcpRequest()` | `apps/mcp/src/main.ts` |
| 工具注册 | `createMcpServer()` 注入 `HybridRetriever` 与 `DbMcpRepository`，注册 `kb.search`、`kb.related`、`kb.preview` | `apps/mcp/src/index.ts` |
| 工具实现 | `kb.search` 复用 Retriever + attachments，`kb.related` 查找同文档邻居，`kb.preview` 返回 chunk+附件 | `apps/mcp/src/tools/{search,related,preview}.ts` |
| 数据访问 | `DbMcpRepository` 封装 chunk/attachment 查询、邻居扩展 | `apps/mcp/src/repository/db.ts` |

### 2.5 Web 控制台与脚本

| 功能点 | 描述 | TS 文件 |
| --- | --- | --- |
| 前端入口 | React/Vite 入口 `main.tsx`，`App.tsx` 组织路由 | `apps/web/src/main.tsx`, `apps/web/src/App.tsx` |
| 页面能力 | 玻璃态 UI，卡片/表格布局：上传（`IngestionDashboard`）、队列进度（`QueueMonitorPage`）、搜索+详情弹窗（`SearchPage`）、元数据治理+编辑弹窗（`MetadataEditorPage`）、治理/诊断/MCP/模型配置等 | `apps/web/src/pages/*.tsx`, `apps/web/src/components/*` |
| Web API 封装 | `api.ts` 定义与 `apps/api` 的 HTTP 交互（上传、检索、治理、队列、chunk 元数据 PATCH） | `apps/web/src/api.ts` |
| 运维脚本 | 
  - `scripts/api-smoke.ts`: 调用 `/documents`→`/search`→`/mcp/preview` 完成本地冒烟
  - `scripts/run-migrations.ts`: 运行数据库迁移
  - `scripts/test-matrix.ts`: 编排 Vitest/Playwright 矩阵测试
  - `scripts/bootstrap-storage.ts` / `sync-models.ts`: 初始化 MinIO 桶、下载本地模型 | `scripts/*.ts` |

## 3. 数据流描述

### 3.1 上传 → 切块 → 索引 Flow

1. **上传/登记**：客户端调用 `POST /upload` → `apps/api/src/routes.ts` 的 `handleUpload()` 将文件写入 `ObjectStorage`（`packages/data/src/storage/minio.ts`），使用 `DocumentSchema` 生成 `docId`，并记录 `documents` 表（`DocumentRepository`）。
2. **入队**：同一函数调用 `enqueueIngestion()`，借助 `QueueAdapter`（默认 `RabbitQueueAdapter`，`packages/data/src/queue/rabbitmq.ts`）向 `kb.ingestion` 推送 `IngestionTask`，携带 `docId`、tenant、library。
3. **Worker 订阅**：`apps/worker/src/worker.ts` 的 `startWorker()` 订阅队列，进入 `handleQueueMessage()`，出错会通过 `documents.updateStatus()` 标记 `failed`。
4. **原文获取与解析**：`apps/worker/src/pipeline.ts` 的 `fetchSource()` 读取 MinIO 原文/临时文件；`parseDocument()` 联合 parser 与 OCR 抽取元素。
5. **预处理与分段**：`preprocessRawText()` 标准化 → 按标题/章/节/空行/短行分段（处理英文连字符），得到 coarse segments。
6. **语义切分与小 Chunk**：对每个 coarse segment 调用 `semanticSegmenter` 生成层级 blueprint，再用 `materializeChunksFromBlueprints()` 结合段落与 token 上限生成小 chunk，保留 `hierPath` 与 `parentSectionPath`。
7. **元数据与标签**：`extractMetadata()` 调用 LLM 生成标题/摘要/标签/关键词/NER/父路径；`generateRemoteTags()` 并发 3 路、重试 3 次。
8. **附件生成**：`prepareAttachments()` 把解析出的表格/图片写入 `attachments` 表，并保留 `objectKey`。
9. **向量化**：`embedChunks()` 借助 `VectorClient` 生成文本/图像向量，`vectorLogs.append()` 记录 provider、耗时与错误。
10. **Persist + 向量库**：`PgKnowledgeWriter.persistBundle()` 在事务内写入 documents/chunks/embeddings/attachments/sections，并调用 `QdrantVectorIndex.upsert()` 同步。
11. **状态更新**：`processIngestionTask()` 完成后将文档状态置为 `indexed`，MetricsRegistry 记录 `kb_ingestion_total` 与 `kb_ingestion_pipeline_seconds`。

### 3.2 检索 → 附件聚合 Flow（REST `/search`）

1. 客户端发起 `POST /search`，`apps/api/src/routes.ts` 校验 `SearchRequestSchema`，补齐 tenant/library 过滤。
2. `HybridRetriever.search()`（`packages/core/src/retrieval.ts`）
   - 通过 `VectorClient.embedText()` 生成查询向量；
   - `ChunkRepository.searchCandidates()` 融合向量召回与 BM25 文本检索，返回向量分数与 `bm25Score`，可再接 rerank；
   - 计算 similarity/keyword/hierarchy/recency/topic/neighbor 权重并排序。
3. API 端基于 `attachmentRepository.listByChunkIds()` 聚合附件，并进行 contentType/semanticTags/envLabels/metadataQuery 过滤，最终返回 `SearchResponseSchema`（含元数据、附件、可选相关段落）。
4. 若命令设置 `searchFilters.hasAttachments` 等，过滤逻辑直接于 `apps/api/src/routes.ts` 处理，保证 REST 层返回的 chunk 带 `attachments` 与 `sourceUri`（`kb://chunk/<id>`）。

### 3.3 MCP 工具 Flow

1. MCP 客户端调用 `POST /mcp/kb.search`（或 `kb.related`, `kb.preview`）。API 可以代理（`apps/api/src/routes.ts`) 或直接使用 `apps/mcp/src/main.ts` 暴露的服务器。
2. `apps/mcp/src/index.ts` 为每个工具注入相同的 `HybridRetriever` 与 `DbMcpRepository`，确保结果与 REST `/search` 一致。
3. `kb.search` 重用了 `HybridRetriever.search()`，但在工具层补齐 tenantId/libraryId（`McpToolContext`），并附加 attachments。
4. `kb.related` / `kb.preview` 通过 `DbMcpRepository.findChunkWithAttachments()` 与 `neighborsFor()` 提供上下文扩展，供 Agent 快速拼接引用片段。

### 3.4 治理与观测 Flow

1. Worker/检索阶段的日志可通过 `/vector-logs`（`apps/api/src/routes.ts`）查询，底层来自 `PgVectorLogRepository`。
2. `/stats`、`/documents/:id/chunks`、`/libraries/:id/chunks` 帮助治理端查看库/文档级指标（`apps/api/src/routes.ts`）。
3. `/metrics` 由 `apps/api/src/server.ts` 暴露 Prometheus 指标，`worker` 也通过 `MetricsRegistry` 采集 ingestion 延迟。

## 4. 快速引用：核心 TS 文件索引

| 类型 | 路径 | 说明 |
| --- | --- | --- |
| REST 启动 | `apps/api/src/main.ts` | API 入口、依赖注入 |
| REST 路由 | `apps/api/src/routes.ts` | 所有上传/检索/治理/MCP 代理逻辑 |
| Worker 入口 | `apps/worker/src/worker.ts` | 构造 Worker 依赖并订阅队列 |
| Ingestion Pipeline | `apps/worker/src/pipeline.ts` | fetch→parse→chunk→metadata→embed→persist |
| MCP Server | `apps/mcp/src/index.ts`, `apps/mcp/src/tools/*.ts` | MCP 工具注册与实现 |
| 检索引擎 | `packages/core/src/retrieval.ts` | HybridRetriever 计算策略 |
| 数据层 | `packages/data/src/index.ts` | createDataLayer()：documents/chunks/queue/storage/vector |
| Web UI | `apps/web/src/pages/*.tsx` | 上传、搜索、治理、MCP 演示界面 |
| 自动化脚本 | `scripts/api-smoke.ts`, `scripts/test-matrix.ts`, `scripts/run-migrations.ts` | CLI/CI 场景的辅助动作 |

---

本拆解可配合 `.codex/context-question-29/30/31.json` 引用的源码行号使用，确保任何功能或 Flow 均能准确追踪至对应 TypeScript 实现。
