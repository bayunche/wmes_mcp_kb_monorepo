下面是一份**可直接落地**的「本地化多模态知识库（KB）+ MCP 服务」的**功能设计、技术方案与搭建步骤**。文档面向 “vibe coding 代码助手” 来生成实际代码与容器编排文件，因此**不包含代码示例**，但提供了完整的接口契约、数据结构字段、模块职责与验收清单，按此实现后开箱即用。

---

## 0. 目标与约束

**目标**

* 通过 **MCP（Model Context Protocol）** 暴露 KB 能力，供大模型 Agent 动态检索与调用。
* 提供 **HTTP API** 以便外部系统上传/解析文件、检索内容、管理元数据。
* 以 **“结构化 → 语义召回”** 的方式构建与检索：为每个知识块生成语义向量、主题标签、层级路径等元数据。
* 支持 **自然语言/关键词** 的**动态语义召回**，并具备**上下文理解、层级关联与原文溯源**能力。
* **多模态** 支持：文本、表格、图片（含 OCR 与图像向量）。
* **Docker 本地部署**，使用自有代码，离线优先，可逐步替换模型或组件。

**硬性约束**

* 不依赖公有云专有服务（可选离线向量模型与 OCR）。
* 方案须涵盖：模块划分、数据模型、检索算法、API/MCP 契约、部署编排、监控与验收。

---

## 1. 总体架构

**核心服务分层**

1. **API 网关层（REST）**

   * 鉴权、租户隔离、配额限流；对外提供上传、检索、管理接口。
2. **MCP 服务层**

   * 以 MCP 工具/资源形式暴露检索、上下文拼装、溯源预览等能力。
3. **处理与索引层（Ingestion + Indexing）**

   * 文件接收、解析（文本/表格/图片）、清洗切块、元数据抽取、嵌入向量计算、入库与构建层级关系图。
4. **检索与重排层（Retrieval + Rerank）**

   * 混合检索（向量 + 关键词 BM25 + 结构化过滤）与层级/上下文拼装；跨模态融合与重排。
5. **数据与存储层**

   * 关系型（Postgres）保存文档/块/标签/关系图；
   * 向量库（Qdrant 或 Postgres+pgvector）；
   * 对象存储（MinIO）存原始文件与切片资源（图片、表格附件）；
   * 队列（Redis/RabbitMQ）解耦上传与异步索引。

**推荐基础组件（离线友好）**

* DB：Postgres（含 pgvector）或 Qdrant（向量）。
* 对象存储：MinIO。
* 消息队列：Redis（Streams）或 RabbitMQ。
* 文档解析：Unstructured / Tika；PDF 解析配合 pdfplumber；表格为 pandas/pyexcel；图片经 Tesseract 或 PaddleOCR。
* 向量模型（中文优先）：

  * 文本向量：bge-m3 或 m3e-large（中英双语、检索友好）。
  * 重排模型：bge-reranker-v2（cross-encoder）。
  * 图像向量：OpenCLIP（ViT-B/32 或更优）。
* 运行监控：Prometheus + Grafana；日志：ELK/Opensearch（可选）。

---

## 2. 数据模型（逻辑）

> 以下为字段与关系的**设计规范**，实现时请据此建表/映射；字段命名可保持一致以降低沟通成本。

### 2.1 文档与块（Documents & Chunks）

* **documents**

  * `doc_id`（ULID，时间可排序）
  * `title`（字符串）
  * `source_uri`（字符串，文件路径或外链）
  * `mime_type`（字符串，例：application/pdf）
  * `language`（ISO 语言码，可为空）
  * `checksum`（SHA256，去重与版本）
  * `size_bytes`（整型）
  * `created_at` / `updated_at`（时间）
  * `tenant_id`（字符串，多租户）
  * `ingest_status`（枚举：uploaded/parsed/indexed/failed）
  * `tags`（字符串数组，文档级标签）

* **chunks**（语义检索的基本单元）

  * `chunk_id`（ULID）
  * `doc_id`（外键）
  * `hier_path`（字符串数组，例如：["合同","第3条","付款"]）
  * `section_title`（字符串，可选）
  * `content_text`（文本；表格序列化后存 Markdown/CSV 摘要）
  * `content_type`（枚举：text/table/image/caption）
  * `page_no`（整型，原文页码）
  * `offset_start` / `offset_end`（整型，文本在原文偏移；图片为空）
  * `bbox`（浮点数组 [x1,y1,x2,y2]，PDF 坐标；文本/图片可有）
  * `entities`（JSON 字段，命名实体与类型）
  * `topic_labels`（字符串数组，主题标签）
  * `score_quality`（浮点，可选，用于文档质量/权威度）

* **embeddings**

  * `emb_id`（ULID）
  * `chunk_id`（外键）
  * `modality`（枚举：text/image/table）
  * `model_name`（字符串）
  * `vector`（向量列）
  * `dim`（整型）
  * `created_at`（时间）

### 2.2 关系与引用（Hierarchy & Graph）

* **relations**

  * `src_chunk_id`
  * `dst_chunk_id`
  * `rel_type`（父子/同级引用/跨文档引用/图表引用/表格引用）
  * `weight`（浮点，语义或结构亲和度）

* **attachments**

  * `asset_id`（ULID）
  * `doc_id` / `chunk_id`
  * `asset_type`（image/table/excel_sheet/slide）
  * `object_key`（MinIO 键）
  * `mime_type`
  * `page_no` / `bbox`（适用时）

> 以上关系支持**层级关联**与**跨块引用**，用于检索时的**上下文扩展**与**原文溯源**。

---

## 3. 解析与索引流程（Ingestion & Indexing）

**触发方式**：上传 API、批量导入目录、或定时任务。
**处理流水线（异步队列驱动）**：

1. **接收与登记**

   * 校验 MIME、计算 `checksum`，命中则执行“版本化/去重策略”。
   * 生成 `doc_id`，写入 `documents`，`ingest_status=uploaded`，原文件入 MinIO。

2. **解析 + 文本清洗**

   * 文本：抽取章节标题、段落、页码；统一编码、去页眉页脚、水印、重复空白。
   * 表格：结构化抽取；存附件记录；生成“可读摘要”（如首行列名 + 若干示例行）用于文本向量。
   * 图片：OCR（可配置），生成 `caption` 与可选 `tags`（场景/对象类别）。

3. **语义切分（LLM）**

   * 将清洗后的全文传入 `semanticSegmenter`（可自选 LLM），输出“章节 → 小节 → 语义块”的结构树：`{sectionId,parentSectionId,title,level,path,content}`。
   * Worker 禁止回退到字数/正则切分，LLM 输出为空即视为错误。
   * 结构树写入 `document_sections`，可通过 API `/documents/:docId/structure` 直接读取。

4. **Chunking & 元数据**

   * 以 LLM 给出的段落作为 chunk，继承 `parentSectionId` 与 `path`。
   * 通过第二个 LLM（或扩展 prompt）为每个 chunk 自动生成：
     * `title / summary / tags / topics / keywords`
     * `entities`（人名/组织/产品/概念/地名……）、`biz_entities`
     * `parentSectionPath`（冗余存储便于检索过滤）
   * 所有字段写入扩展后的 `chunks` 表，成为后续检索过滤与排序依据。

5. **向量化与入库**

   * 文本向量：bge-m3；表格文本化摘要同样生成文本向量。
   * 图片向量：CLIP。
   * 写入 `embeddings` 与向量库（Qdrant/pgvector），标注 `modality`。
   * `ingest_status=indexed`。

6. **关系/附件写入**

   * 父子关系、同级“近邻块”、跨文档引用（如“见附录 A”识别）。
   * 图片/表格与文本段落的“说明-对象”关系（图注/表注）。

**失败与重试**：任何阶段失败记录错误信息，支持 N 次重试与死信队列，便于运维定位。

---

## 4. 检索与动态语义召回（核心算法）

### 4.1 查询理解（Query Understanding）

* 解析用户查询的：意图、关键词、主题标签候选、时间/数值约束、层级偏好（如“第3章付款”）、模态偏好（如“附图”）。
* 生成查询向量（文本）与可选关键词列表、结构过滤器（`topic_labels`、`hier_path` 片段、`doc_id` 范围、时间窗）。

### 4.2 混合检索（Hybrid Retrieval）

* **候选集构建**：

  * 向量相似度（余弦） Top-K（多模态并行：text + image + table-as-text）；
  * 关键词 BM25 Top-K；
  * 结构化过滤（标签/路径/时间）提前或事后过滤。
* **融合排序**（默认权重，可配置）：

  * 设 `S = α·cos_sim + β·BM25 + γ·path_proximity + δ·recency + ε·authority + ζ·modality_match`
  * `path_proximity`：当查询含“章节/路径线索”时，层级越近得分越高；
  * `recency`：按 `documents.updated_at` 衰减；
  * `authority`：来源可信度或人工权重；
  * `modality_match`：用户指向图片/表格时提升相应块。

### 4.3 层级扩展与上下文拼装

* 对首批命中块，按关系图向**父/兄/子**扩展，限定窗口（如每个主命中块 ±2 个近邻）。
* 进行去重与过密惩罚（Maximal Marginal Relevance），保证多样性。
* 组装为**“上下文包（Context Pack）”**：

  * 主命中块（evidence）+ 解释性邻近块（supporting）+ 原文溯源标引（`doc_id/page/bbox`）。

### 4.4 重排（Rerank）与答案准备

* 使用 cross-encoder（bge-reranker-v2）对候选进行短列表重排，提高语义精度。
* 输出包含：块文本摘要、层级路径、主题标签、原文定位 URI（见 6.3）。

---

## 5. 功能列表（对外能力）

### 5.1 上传/解析/索引

* 支持：PDF、DOCX、PPTX、XLSX、MD/TXT、CSV、PNG/JPG。
* 批量上传；断点续传（可选）；版本管理；去重；失败重试。
* 可配置：OCR 开关、块大小、向量模型、重叠长度、标签体系。

### 5.2 检索能力

* 模式：自然语言问句、关键词检索、结构过滤（标签/路径/时间）、模态过滤。
* 结果：

  * **上下文理解**：返回命中块及其上下文包；
  * **层级关联**：可展开上/下级关系；
  * **原文溯源**：页码、偏移、坐标、对象存储链接；
  * **多模态**：返回图片/表格附件预览信息与 caption；
  * **可复现性**：包含模型名、向量维度与检索权重参数快照（用于审计）。

### 5.3 维护与治理

* 文档与块的增删改；标签体系维护；关系重建；重索引（换模型/参数）。
* 统计报表：语料规模、检索命中率、失败率；
* 审计日志：谁在何时检索到哪些文档（可匿名化）。

---

## 6. 接口契约（API 与 MCP）

> 为方便实现与联调，以下以**列表 + 字段说明**的形式定义接口，不提供代码示例。

### 6.1 REST API（对外）

**鉴权**：建议使用 JWT（`Authorization: Bearer <token>`）；多租户通过 `X-Tenant-Id`。

1. **创建上传会话**

* 路径：`POST /v1/uploads`
* 输入字段：`filename`、`mime_type`、`size_bytes`、`checksum`（可选，命中则走版本策略）、`tags`（可选）
* 输出字段：`upload_id`、`doc_id`、`upload_urls`（分片策略可选）、`expires_at`

2. **完成上传**

* 路径：`POST /v1/uploads/{upload_id}/complete`
* 输出字段：`doc_id`、`ingest_status`（进入解析队列）

3. **查询文档状态**

* 路径：`GET /v1/documents/{doc_id}`
* 输出字段：文档基本信息、`ingest_status`、解析/索引日志摘要

4. **检索**

* 路径：`POST /v1/search`
* 输入字段：

  * `query`（字符串）
  * `filters`（对象：`topic_labels`（数组）、`hier_path_prefix`（数组）、`mime_types`、`date_from`/`date_to`、`modality`）
  * `options`（对象：`k`、`alpha/beta/…` 融合权重、`expand_context`（布尔））
* 输出字段：

  * `results`（数组）：每项含 `chunk_id/doc_id/score/modality/summary/topic_labels/hier_path/page_no/offset/bbox`
  * `context_pack`（可选，按 `expand_context` 返回主证据与邻近块）
  * `provenance`（对象：`source_uri/object_keys`）
  * `debug`（可选：实际权重、模型名、命中文档统计）

5. **原文预览（溯源）**

* 路径：`GET /v1/preview/{doc_id}`
* 查询参数：`page_no`、`bbox`（可选，返回高亮区域）
* 输出：可直接渲染的图片/矢量预览链接或短期签名 URL

6. **文档/块管理**

* `GET /v1/chunks/{chunk_id}`：返回块详情与关系邻居
* `PATCH /v1/chunks/{chunk_id}`：更新元数据（标签、路径）
* `DELETE /v1/documents/{doc_id}`：级联删除（软删/硬删可选）
* `POST /v1/reindex`：触发重索引（按 `doc_id` 或标签/时间窗）

7. **统计与健康**

* `GET /v1/stats`：语料量、向量量、最近检索 QPS
* `GET /v1/health`：各服务健康检查汇总

### 6.2 错误约定

* 统一错误对象：`code`（枚举）、`message`（人类可读）、`details`（上下文）
* 常见 `code`：`INVALID_ARGUMENT` / `NOT_FOUND` / `ALREADY_EXISTS` / `RATE_LIMITED` / `INTERNAL`

### 6.3 原文溯源 URI 规范

* 文档：`kb://doc/{doc_id}`
* 块：`kb://chunk/{chunk_id}`
* 预览锚点：追加查询参数：`?p={page_no}&bbox=x1,y1,x2,y2`
* 对象存储直链：经签名 URL，短期有效，含 `object_key`

### 6.4 MCP 服务（对 Agent）

**传输**：stdio 或 WebSocket 均可；服务端声明以下工具（tools）与资源（resources）。

**Tools（名称 → 作用 → 参数）**

* `kb.search` → 语义/混合检索

  * `query`（字符串，必填）
  * `filters`（同 REST）
  * `k`、`expand_context`、`weights`（alpha/beta/…）
* `kb.lookup` → 以 `chunk_id/doc_id` 精确获取块/文档元数据与溯源锚点

  * `ids`（数组）
* `kb.related` → 给定 `chunk_id`，返回父/兄/子/引用邻居

  * `chunk_id`、`direction`（parent/child/sibling/ref）
* `kb.preview` → 返回可嵌入的预览信息（页图、bbox 高亮链接）

  * `doc_id`、`page_no`、`bbox`
* `kb.upsert` → Agent 产出的结构化知识写回（可选）

  * `payload`（对象：`doc` 与 `chunks`）
* `kb.delete` → 软删文档/块

  * `ids`（数组）、`type`（doc/chunk）
* `kb.summarize` → 对命中块做对齐式摘要（为 Agent 控制上下文长度）

  * `chunk_ids`、`style`（brief/bullets/strict-citation）

**Resources**

* `kb://doc/*` 与 `kb://chunk/*` 可作为可列举资源，支持分段读取与元数据查看。
* MCP `list_resources` 可按标签/路径列出文档树，利于 Agent 做“浏览式选择”。

**Prompts（可选）**

* 提供“检索提示词模板”：如何结合标签/路径/模态过滤发起精准检索与溯源引用。

---

## 7. 策略与算法细节

### 7.1 切块策略（默认）

* 文本：按标题层级优先切块，辅以 token 窗口与轻度重叠；保证每块语义自洽且便于上下文扩展。
* 表格：保留整表为附件；生成“表头+示例行”的**可检索摘要块**；对大表可分区摘要。
* 图片：caption 与检测标签作为文本块；图片本体存附件，向量用于模态召回。

### 7.2 动态语义召回权重（默认）

* `alpha=0.55`（向量）
* `beta=0.25`（BM25）
* `gamma=0.10`（层级接近）
* `delta=0.05`（新鲜度）
* `epsilon=0.03`（权威度）
* `zeta=0.02`（模态匹配）

> 权重在 API/MCP 中可调，返回 `debug` 以便复盘。

### 7.3 重排与多模态融合

* 文本候选由 cross-encoder 重排；
* 图像/表格候选采用**晚融合**（late fusion）：分通道检索，统一归一化后融合；如查询显式“图/表”，调高 `zeta` 或直接先验提升相应通道。

---

## 8. 安全、合规与多租户

* **鉴权**：JWT；可选 OAuth2；MCP 层共享同一验证模块。
* **租户隔离**：所有主表含 `tenant_id`；对象存储以租户前缀分桶/目录；检索时自动注入租户过滤。
* **PII/敏感识别**：解析阶段可插入脱敏器；提供“原文可见/不可见”字段控制预览。
* **审计**：记录每次检索的查询、命中文档与溯源 URI（可哈希化内容以保护隐私）。
* **配额与限流**：按租户/令牌配置 QPS 与并发索引数。

---

## 9. 部署方案（Docker，本地）

> 由代码助手生成 docker 编排；此处给出**服务清单、关键环境参数与依赖**，实现后可一键启动。

**服务清单**

1. `kb-api`：REST + 鉴权 + 任务投递

   * 端口：`8080`
   * 依赖：`db`、`vectordb`、`object`、`queue`
2. `kb-worker`：解析/切块/向量化/入库

   * 并发可配置；需挂载模型与临时目录
3. `db`：Postgres（含 pgvector 扩展）

   * 持久化卷：`/var/lib/postgresql/data`
4. `vectordb`：Qdrant（若用 Postgres+pgvector可省略）

   * 端口：`6333`
5. `object`：MinIO

   * 端口：`9000`（API）、`9001`（控制台）
   * 桶：`kb-raw`、`kb-preview`
6. `queue`：Redis 或 RabbitMQ
7. `mcp-server`：对接 KB 的 MCP 进程（可与 `kb-api` 合并为单镜像两个进程）
8. **可选**：`prometheus`、`grafana`、日志栈

**关键环境参数（示例命名）**

* 模型目录：`MODELS_DIR`（bge-m3、bge-reranker、OpenCLIP）
* OCR 开关与语言：`OCR_ENABLED=true`、`OCR_LANG=chi_sim`
* 切块参数：`CHUNK_TOKENS=512`、`CHUNK_OVERLAP=64`
* 混合检索权重：`ALPHA/BETA/GAMMA/DELTA/EPSILON/ZETA`
* MinIO：`MINIO_ENDPOINT/ACCESS_KEY/SECRET_KEY/BUCKET_RAW/BUCKET_PREVIEW`
* Qdrant/Postgres：连接串与超时设置
* 安全：`JWT_ISSUER/JWT_AUDIENCE/JWT_PUBLIC_KEY`
* 多租户默认：`DEFAULT_TENANT_ID`

**启动顺序**
对象存储与数据库 → 向量库/队列 → API 与 MCP → Worker。
**健康检查**：各服务提供 `/health`；启动脚本阻塞直到所有依赖健康。

---

## 10. 监控与运维

* **指标**：

  * Ingestion 延迟：上传→indexed 时间；
  * 检索：P95 延迟、命中率、Rerank 花费；
  * OCR/解析失败率；
  * 向量库容量与召回耗时。
* **告警**：队列堆积、对象存储剩余空间、DB/向量库连接错误。
* **备份**：

  * Postgres 与 Qdrant 定期快照；
  * MinIO 桶镜像到本地盘/异地盘；
  * 备份与恢复脚本按租户维度执行。
* **迁移**：模型或向量升级需提供“并行索引”与“蓝绿切换”标记（双写、双检索对比后切换）。

---

## 11. 性能与容量规划（参考）

* 单机 16C/64G/1TB NVMe：

  * 约 **100–200 万块**（text+table+image）规模；
  * Qdrant/pgvector 向量维度 768–1024；
  * 检索延迟（Top-50）~50–150ms（不含重排）；
  * Rerank Top-200→Top-20 ~100–300ms（看模型与并发）。
* 扩容：向量库分片、API 横向扩展、Worker 水平扩展；MinIO 可 Gateway 扩展。

---

## 12. 验收用例（E2E）

1. **多模态文档上传**：PDF（含表格与图片）+ PPTX + XLSX

   * 期望：`documents.ingest_status=indexed`，`chunks` 含 text/table/image 三类；附件可预览；页码/坐标正确。

2. **自然语言检索**：“付款节点和违约金在第几条？”

   * 期望：返回对应章节块，显示 `hier_path`、`page_no`、`bbox`；可展开上下文与原文预览。

3. **表格聚焦**：“列出《价格表》中的折扣范围”

   * 期望：召回表格摘要块 + 附件预览；原表定位正确。

4. **图片检索**：“找项目流程图”

   * 期望：以图像向量召回对应图片块，显示 caption 与预览链接。

5. **结构过滤**：“合同·第3章 的所有付款条款”

   * 期望：通过 `hier_path_prefix` 精准过滤，返回同层与子层块；层级扩展有效。

6. **MCP 集成**：Agent 通过 `kb.search` 获取 `context_pack` 并引用 `kb://chunk/*`

   * 期望：Agent 能用溯源 URI 生成可核验回答；`kb.related` 可拉邻居块补充。

7. **治理操作**：重索引、删除文档、查看统计健康

   * 期望：接口权限控制生效；审计日志记录关键信息。

---

## 13. 路线图（可选增强）

* **知识图谱增强**：将实体/关系写入图数据库（Neo4j），支持图检索与 reasoning。
* **表格问答**：对结构化表格引入轻量 SQL/DF 推理，回答聚合类问题。
* **半结构化抽取**：合同条款、日期金额等生成标准字段，供精确过滤。
* **多语言**：按语料自动语言识别与分桶向量化。
* **在线学习**：基于点击/反馈的 rerank 学习，调节融合权重。

---

## 14. 交付物清单（请由代码助手生成）

1. **后端服务**：`kb-api`、`kb-worker`、`mcp-server` 源码与可运行镜像。
2. **数据库迁移脚本**：建表、索引、pgvector/集合定义。
3. **模型打包**：文本向量、重排、CLIP、OCR 语言包离线资源目录。
4. **Docker 编排**：包含所有服务、网络、卷、健康检查与依赖。
5. **配置样例**：`.env`/环境变量表，权重与切块参数。
6. **运维脚本**：初始化（建桶、建索引）、备份/恢复、重索引、滚动升级。
7. **文档**：API 说明、MCP 工具/资源说明、验收手册、常见问题。

---

## 15. 最终“可用性”校验清单（上线前必过）

* [ ] 所有服务健康检查为 **OK**，监控面板无红警。
* [ ] 上传 → 解析 → 切块 → 向量化 → 入库全链路成功率 ≥ 99%。
* [ ] Top-5 召回的**正确性**经抽样验证（文本/表格/图片各 50 例）。
* [ ] 原文预览定位（页码/坐标）误差在可视像素阈值内。
* [ ] MCP 端到端联调：Agent 能在 5 次以内检索到正确证据并输出带溯源的回答。
* [ ] 安全基线：鉴权、租户隔离、审计日志、最小权限存取均生效。

---

以上方案已覆盖你提出的全部要求：MCP 暴露、REST API 上传解析、多模态与结构化→语义召回、上下文与层级关联、原文溯源、本地 Docker 化部署与直接可用的验收路径。将本设计交给 “vibe coding 代码助手” 即可生成实现与编排文件，按文档部署后即可投入使用。若你需要，我可以把上述接口与字段整理成一份更细的“字段—类型—约束”表格规范或测试用数据清单。
