FROM oven/bun:1.1.13 as base
WORKDIR /app

COPY package.json bun.lock bunfig.toml tsconfig.json tsconfig.base.json vitest.config.ts ./
COPY apps ./apps
COPY packages ./packages
COPY scripts ./scripts
COPY docs ./docs
COPY assets ./assets
COPY ops ./ops
COPY db ./db
COPY tests ./tests

# 只在 data 包里装一次（不再 ln）
WORKDIR /app/packages/data
RUN bun install --frozen-lockfile

WORKDIR /app
ENV NODE_ENV=production
ENV START_WORKER=true
CMD ["bun", "run", "apps/worker/src/main.ts"]
