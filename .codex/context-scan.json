{
  "timestamp": "2025-11-19T16:43:02+08:00",
  "workspace": "/mnt/d/code/mcp知识库/wmes_mcp_kb_monorepo",
  "focus": "重构前端上传/配置/治理流程，并确保语义与向量模型配置（含 API Key）持久化在数据库中，模型列表必须通过 API 拉取，租户/库的选择需来自配置页面",
  "locations": {
    "frontend": [
      "apps/web/src/App.tsx（当前路由入口，需重新组织 Tab）",
      "apps/web/src/components/{UploadForm,IngestionStatusPanel,MetadataEditor,VectorLogPanel}.tsx（上传/队列/标签/诊断模块）",
      "apps/web/src/pages/{IngestionDashboard,Gov...,ModelSettingsPage}.tsx（页面布局与配置表单）",
      "apps/web/src/api.ts（所有 API 请求入口，需新增租户/库/模型目录接口）"
    ],
    "backend": [
      "apps/api/src/routes.ts（/model-settings、/documents、/libraries/* 等路由，需扩展模型目录/租户列表）",
      "packages/data/src/repositories/modelSettings.ts（模型配置持久化，含 API Key 字段）",
      "db/migrations/0004_semantic_pipeline.sql 等（model_settings 表结构，确认字段齐全）"
    ]
  },
  "current_state": {
    "model_persistence": "PgModelSettingsRepository 已支持 provider/baseUrl/modelName/apiKey/options，但 UI 仍允许手动输入模型名，未强制从目录选择",
    "ui_inputs": "上传表单与治理面板中的 Tenant/Library/标签/标题均为手动输入；标签支持自定义且没有自动填充",
    "routing": "App.tsx 当前仅有 Ingestion/Docs/Search/Governance/MCP/Settings 六个 Tab，Ingestion 面板混合了上传、队列、标签微调、日志等多功能",
    "catalog_fetch": "ModelSettingsPage 通过 fetchModelCatalog() 获取 `model-settings/catalog`，但 modelName 输入域仍允许自由输入，未做绑定",
    "diagnostics": "队列监控 IngestionStatusPanel、VectorLogPanel、StructureTree 均挂载在 Ingestion 页面而非独立路由"
  },
  "similar_assets": [
    "docs/ingestion.md（描述上传/解析/嵌入流程，可对齐 UI 文案）",
    "docs/retrieval.md（用于解释模型配置）",
    "apps/web/src/pages/DocumentsList.tsx（展示文档/标签，可迁移到治理区）"
  ],
  "tech_stack": [
    "前端：Vite + React + TypeScript + react-router-dom",
    "后端：Bun + Fastify 路由 + Kysely + Postgres",
    "样式：定制 CSS（apps/web/src/styles.css）"
  ],
  "tests": {
    "available": [
      "bun test（验证 API/worker/mcp 单测）",
      "bun run scripts/test-matrix.ts（smoke + integration）"
    ],
    "notes": "当前 WSL 环境无法执行 Bun，可在宿主机复跑；前端改动需运行 `bun run web` 或 `bun test`（如果存在 UI 测试）"
  },
  "observation_report": [
    "模型配置虽已写入 model_settings 表，但 UI/请求层未限制来源，且上传页无法复用配置好的 tenant/library 列表",
    "入库页面承担过多功能，需要按“上传/队列/治理/诊断”重新分路由",
    "标签在后端可自动生成，上传表单应去掉标签输入并自动根据标题生成初始标签",
    "文件选择后未自动填充标题，需监听 File input",
    "需要新增租户/库/模型的配置管理接口供下拉选择"
  ]
}
