{
  "timestamp": "2025-11-18T21:05:28+08:00",
  "workspace": "/mnt/d/code/mcp知识库/wmes_mcp_kb_monorepo",
  "focus": "梳理整套知识库系统的业务功能并输出功能点拆解文档，需标注关键 TypeScript 文件及端到端数据流",
  "locations": {
    "api_gateway": [
      "apps/api/src/main.ts（引导 Bun API 服务器与 HybridRetriever）",
      "apps/api/src/server.ts（HTTP/CORS/Auth + metrics 暴露）",
      "apps/api/src/routes.ts（上传/检索/治理/MCP 代理各路由）"
    ],
    "ingestion_worker": [
      "apps/worker/src/worker.ts（Worker 启动、依赖装配、OCR/模型注入）",
      "apps/worker/src/pipeline.ts（fetch → parse → chunk → metadata → embed → persist 全流程）",
      "apps/worker/src/types.ts（数据结构与阶段依赖定义）"
    ],
    "mcp_server": [
      "apps/mcp/src/server.ts（createMcpServer 与工具暴露）",
      "apps/mcp/src/tools/{search,related,preview}.ts（kb.* 工具实现）",
      "apps/mcp/src/repository/db.ts（数据库访问封装）"
    ],
    "shared_packages": [
      "packages/core/src/{config,retrieval,vector,parsing,ocr,semantic-*}.ts",
      "packages/data/src/index.ts（Kysely repository + queue/storage/vectorIndex）",
      "packages/shared-schemas（Zod schema 与类型约束）"
    ],
    "docs_and_specs": [
      "README.md（架构、高亮功能与部署路径）",
      "docs/ingestion.md、docs/retrieval.md、docs/mcp.md（子流程细节）",
      "项目需求.md（中文需求背景）"
    ]
  },
  "current_state": {
    "architecture": "README 已交代 API → Queue → Worker → Vector/DB → MCP/REST 的主干，apps/api 负责上传与检索，apps/worker 完成解析切块+元数据生成+嵌入并写回 data layer。",
    "data_plane": "packages/data 统一了 Postgres/Kysely、MinIO、RabbitMQ、pgvector/Qdrant 索引适配，API/Worker/MCP 共用 createDataLayer()。",
    "retrieval": "HybridRetriever (packages/core/src/retrieval) 组合向量召回与 rerank；API /search 与 MCP 工具均共用该实例，并在 routes.ts 中追加附件/标签过滤逻辑。",
    "mcp_integration": "apps/mcp 暴露 kb.search/kb.related/kb.preview，API 通过 /mcp/* 将 REST/Token 模式对接 MCP 客户端，实现统一检索能力。",
    "worker_pipeline": "pipeline.ts 的 processIngestionTask 协调 fetchSource→parseDocument→chunkDocument→extractMetadata→embedChunks→persistBundle，并在 metrics + vectorLogs 中记录过程。"
  },
  "similar_assets": [
    "docs/ingestion.md - 描述上传/解析/嵌入/持久化流程",
    "docs/retrieval.md - HybridRetriever 配置与搜索策略",
    "docs/mcp.md - kb.* 工具接口参考",
    "README.md - Highlights/Architecture/Quick Start",
    "项目需求.md - 业务背景与目标"
  ],
  "tech_stack": [
    "Bun 1.x + TypeScript（API/Worker/MCP）",
    "React + Vite（apps/web，仅做背景参考）",
    "Postgres + pgvector + Qdrant + MinIO + RabbitMQ",
    "Zod + Kysely + @xenova/transformers",
    "Vitest + bun test"
  ],
  "tests": {
    "available": [
      "bun test（根目录 Vitest 配置）",
      "make test（pytest? — 但 Monorepo 主要使用 bun test / scripts/test-matrix）",
      "scripts/api-smoke.ts、scripts/test-matrix.ts"
    ],
    "notes": "功能拆解文档无需运行测试，但后续若验证 API 行为可用 bun test 或 scripts/api-smoke.ts。"
  },
  "observation_report": [
    "当前任务需要纵览 API/Worker/MCP/Packages 中的关键 TS 文件以描述功能点及数据流，需跨目录阅读，信息量较大。",
    "仓库未配置 code-index MCP 工具，无法使用固化索引检索，只能通过 shell/rg 进行源代码搜索，已在此记录。",
    "数据流描述可以复用 README + docs/ingestion.md/retrieval.md 的叙述，再结合 apps/* 源码进行补充，确保最终文档具备依据。"
  ]
}
