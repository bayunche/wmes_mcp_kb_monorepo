{
  "timestamp": "2025-11-20T20:43:47+08:00",
  "workspace": "/mnt/d/code/mcp知识库/wmes_mcp_kb_monorepo",
  "focus": "排查 OCR HTTP 连接失败并对接 paddle OCR docker 服务，同时补齐 metadata 角色模型配置以避免 ingestion 中断",
  "locations": {
    "ocr": [
      "packages/core/src/ocr.ts（HttpOcrAdapter/LocalOcrAdapter，构造 multipart 并解析返回）",
      "apps/worker/src/worker.ts（createOcrAdapter 根据 OCR_MODE/ENV 注入）",
      "paddle/server.py、paddle/docker-compose.yml（本仓库自带 paddle OCR 服务示例）",
      "README.md#PaddleOCR 本地部署（332-416 行，配置与验证步骤）"
    ],
    "ingestion": [
      "apps/worker/src/pipeline.ts（extractMetadata 抛出 \"缺少 metadata 角色模型配置\" 阻断流程；chunkDocument/shouldUseOcr 调用）",
      "apps/worker/src/worker.ts（startWorker 依赖 model_settings、semanticMetadata 注入）",
      "db/migrations/0004_semantic_pipeline.sql（model_settings 增加 role=metadata/ocr/rerank 等约束）"
    ],
    "config": [
      "packages/core/src/config.ts（OCR_ENABLED/OCR_MODE/OCR_API_URL/OCR_LOCAL_COMMAND 等环境变量定义）",
      ".env.example（OCR_* 默认值，metadata 模型无环境变量需走 model_settings）"
    ]
  },
  "current_state": {
    "ocr_adapter": "HttpOcrAdapter 使用 fetch POST multipart/form-data，字段 file/response_format=json/language，并可附加 Authorization Bearer；timeout 默认 60s，endpoint 取 OCR_API_URL，mime/filename 由上传源决定（packages/core/src/ocr.ts）",
    "ocr_routing": "Worker createOcrAdapter 在 OCR_MODE=http 且 OCR_API_URL 存在时注入 HttpOcrAdapter；auto 模式优先本地命令再回落 HTTP，否则禁用（apps/worker/src/worker.ts）",
    "ingestion_guard": "extractMetadata 要求 model_settings 中存在 metadata 角色配置，否则直接抛错终止 ingestion（apps/worker/src/pipeline.ts:264-279）",
    "paddle_service": "仓库自带 paddle/docker-compose.yml 暴露 http://localhost:8000/ocr，server.py FastAPI 接口符合 HttpOcrAdapter 预期；README 提供 curl 验证与 .env 示例"
  },
  "tests": {
    "existing": "未找到针对 OCR 或 metadata 配置的自动化测试，tests/ 下无 ocr 相关用例",
    "notes": "需要通过手动/脚本调用 paddle /ocr 端点与 worker ingest 路径验证"
  },
  "observation_report": [
    "当前错误表明 OCR_API_URL 未通或服务未起，需按 README 启动 paddle/docker compose 并配置 OCR_MODE=http",
    "metadata 角色未在 model_settings 配置导致 ingest 直接中断，需提供默认模型或配置指引以不中断流程",
    "无回退逻辑：metadata 缺失时直接抛错，OCR 连接失败会导致解析为空；需要改进降级与日志"
  ]
}
